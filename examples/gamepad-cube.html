<!DOCTYPE html>
<html lang=en>
<head>
<meta charset=utf-8>
<title>Gamepad Cube</title>
<script src="https://cdn.rawgit.com/mrdoob/three.js/r74/build/three.min.js"></script>
<script src="https://cdn.rawgit.com/mrdoob/three.js/r74/examples/js/loaders/ColladaLoader.js"></script>
<script src="../dist/altspace.min.js"></script>
</head>
<body>
</body>
<script>

GamepadCube = (function(){

	var sim;
	var sceneSync;
	var cube;
	var cubeModel;

	// Setup
	function main() {
		sim = altspace.utilities.Simulation();
		loadCubeModel();//must load model before creating synced cube
	}

	function onModelReady() {
		var config = { authorId: 'AltspaceVR', appId: 'GamepadCube' };
		altspace.utilities.sync.connect(config).then(function(connection) {
			sceneSync = altspace.utilities.behaviors.SceneSync(connection.instance, {
				instantiators: {'Cube': createCube },
				ready: ready
			});
			sim.scene.addBehavior(sceneSync);
		});
	}

	function loadCubeModel() {
		var loader = new THREE.ColladaLoader()
		var objFilename = "models/boo.dae";
		loader.load(objFilename, function ( obj ) {
			cubeModel = obj.scene;
			cubeModel.traverse(function (o) {
					if (o.material && o.material.materials) {
						o.material = o.material.materials[0];
					}
			});
			onModelReady();
		});
	}

	function createCube(initData) {

		cube = cubeModel.clone();
		cube.scale.multiplyScalar(850);
		cube.position.y = -1200;
		cube.addBehaviors(
			altspace.utilities.behaviors.Object3DSync({position: true, rotation: true, scale: true}),
			altspace.utilities.behaviors.GamepadControls()
		);
		cube.name = 'cube';
		cube.rotation.y += Math.PI / 8;
		cube.rotation.x += Math.PI / 12;
		sim.scene.add(cube);
		return cube;
	}

	function ready(firstInstance) {
		if (firstInstance) {
			sceneSync.instantiate('Cube');
		}
	}

	return {
		main: main,
		getCube: function(){ return cube; },
	};

}());


GamepadCube.main();

</script>
</html>
